<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <title>whtsky</title>
    <link href="http://feeds.feedburner.com/Whtsky" rel="self" />
    <link href="http://whouz.com" />
    <updated>2012-07-10T12:55:46Z</updated>
    <id>http://whouz.com</id>
    
    <entry>
        <title type="html"><![CDATA[在Tornado中获取访客ip
]]></title>
        <link href="http://whouz.com/get-ip-in-tornado.html"/>
        <updated>2012-07-10T12:55:46Z</updated>
        <published>2012-07-10T12:55:46Z</published>
        <id>http://whouz.com/get-ip-in-tornado</id>
        <content type="html" xml:base="http://whouz.com" xml:lang="en">
            <![CDATA[ <p>以前都是用<code>self.request.headers[&#39;X-Real-Ip&#39;]</code>来取访客ip，今天翻源码才发现官方已经给获取好了:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">connection</span> <span class="ow">and</span> <span class="n">connection</span><span class="o">.</span><span class="n">xheaders</span><span class="p">:</span>

            <span class="c"># Squid uses X-Forwarded-For, others use X-Real-Ip</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">remote_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>

                <span class="s">&quot;X-Real-Ip&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Forwarded-For&quot;</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">))</span>
</pre></div>

<p><a href="https://github.com/facebook/tornado/blob/master/tornado/httpserver.py#L358">https://github.com/facebook/tornado/blob/master/tornado/httpserver.py#L358</a></p>

<p>用起来很简单：</p>

<p>把<code>http_server = tornado.httpserver.HTTPServer(application)</code>改成<code>http_server = tornado.httpserver.HTTPServer(application, xheaders=True)</code></p>

<p>然后直接在RequestHandler里使用<code>self.request.remote_ip</code>就可以了</p>
 ]]>
        </content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[记录一下Catsup的Nginx设置
]]></title>
        <link href="http://whouz.com/mark-my-catsup-config.html"/>
        <updated>2012-07-10T12:55:46Z</updated>
        <published>2012-07-10T12:55:46Z</published>
        <id>http://whouz.com/mark-my-catsup-config</id>
        <content type="html" xml:base="http://whouz.com" xml:lang="en">
            <![CDATA[ <p>catsup.conf:</p>

<pre><code>upstream catsup_whtsky{

    server localhost:2331;

}

server {

    server_name whouz.com;



    proxy_read_timeout 200;

    tcp_nopush on;

    gzip_min_length 1000;

    gzip_proxied any;

    proxy_next_upstream error;



    if ($host != 'whouz.com' ) { 

        rewrite  ^/(.*)$  http://whouz.com/$1  permanent; 

    }



    listen 80;



    location / {

        proxy_pass_header Server;

        proxy_set_header Host $http_host;

        proxy_redirect off;

        proxy_set_header X-Real-IP $remote_addr;

        proxy_set_header X-Scheme $scheme;



        # proxy to your upstream

        proxy_pass http://catsup_whtsky;

    }

}



server {

    server_name assets.whouz.com;

    gzip_min_length 1;

    gzip_proxied any;



    listen 80;



    add_header Vary Accept-Encoding;

    access_log   off;



    root /web/catsup/themes/sealscript/static;

    expires 30d;

}</code></pre>
 ]]>
        </content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Mark一下目前的supervisord.conf
]]></title>
        <link href="http://whouz.com/mark-my-supervisord-conf.html"/>
        <updated>2012-07-10T12:55:46Z</updated>
        <published>2012-07-10T12:55:46Z</published>
        <id>http://whouz.com/mark-my-supervisord-conf</id>
        <content type="html" xml:base="http://whouz.com" xml:lang="en">
            <![CDATA[ 
<pre><code>[unix_http_server]

file=/tmp/supervisor.sock   ; (the path to the socket file)



[supervisord]

logfile=/tmp/supervisord.log ; (main log file;default $CWD/supervisord.log)

logfile_maxbytes=50MB        ; (max main logfile bytes b4 rotation;default 50MB)

logfile_backups=10           ; (num of main logfile rotation backups;default 10)

loglevel=warn                ; (log level;default info; others: debug,warn,trace)

pidfile=/tmp/supervisord.pid ; (supervisord pidfile;default supervisord.pid)

nodaemon=false               ; (start in foreground if true;default false)

minfds=1024                  ; (min. avail startup file descriptors;default 1024)

minprocs=200                 ; (min. avail process descriptors;default 200)



[rpcinterface:supervisor]

supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface



[supervisorctl]

serverurl=unix:///tmp/supervisor.sock ; use a unix:// URL  for a unix socket



[program:catsup]

command=python /web/catsup/catsup.py --port=2331

redirect_stderr=true

stdout_logfile=/tmp/catsup.log</code></pre>
 ]]>
        </content>
    </entry>
    
    <entry>
        <title type="html"><![CDATA[Supervisor常用命令
]]></title>
        <link href="http://whouz.com/supervisor-mark.html"/>
        <updated>2012-07-10T12:55:46Z</updated>
        <published>2012-07-10T12:55:46Z</published>
        <id>http://whouz.com/supervisor-mark</id>
        <content type="html" xml:base="http://whouz.com" xml:lang="en">
            <![CDATA[ <p>初始启动：supervisord</p>

<p>启动进程：supervisorctl start &lt;name&gt;</p>

<p>停止进程：supervisorctl stop &lt;name&gt;</p>

<p>重启进程：supervisorctl restart &lt;name&gt;</p>

<p>重新载入：supervisorctl reload</p>

<p>重新载入会读取最新配置并重新启动所有进程。</p>
 ]]>
        </content>
    </entry>
    
</feed>