<!DOCTYPE html>
<html>
<head>
<title>
在Tornado中获取访客ip
 | whtsky
</title>
<link href='http://fonts.googleapis.com/css?family=Abel' rel='stylesheet' type='text/css'>
<link rel="stylesheet" href="http://assets.whouz.com/css/style.css" type="text/css" />
<link rel="stylesheet" href="http://assets.whouz.com/css/pygments_style.css" type="text/css" />
<link rel="alternate" type="application/rss+xml" href="http://feeds.feedburner.com/Whtsky" title="whtsky" />


<script type="text/javascript">
var _gaq = _gaq || [];
_gaq.push(['_setAccount', 'UA-33275966-1']);
_gaq.push(['_trackPageview']);
(function() {
var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
})();
</script>

</head>
<body>
<div id="header">
<div id="nav_wrapper">
<div id="nav">
<div class="inner">
<h1 id="title"><a href="http://whouz.com">whtsky</a></h1>
<div id="description" class="seal">a blog</div>
<ul class="right">

<li><a href="http://jyprince.me/" title="A ballache coder.">Jybox</a></li>
<li class="dot">&bull;</a>

<li><a href="http://www.luztak.net/" title="luztak">Luztak</a></li>
<li class="dot">&bull;</a>

</ul>
</div>
</div>
</div>
<div id="header_inner">
<div id="social">
<a href="http://twitter.com/whouz" target="_blank" title="Follow Me @ Twitter"><img src="http://assets.whouz.com/image/ic16_twitter.png"></a>
<a href="http://github.com/whtsky" target="_blank" title="Fork Me @ Github"><img src="http://assets.whouz.com/image/ic16_github.png"></a>
<a href="http://feeds.feedburner.com/Whtsky" target="_blank" title="Subscribe My Blog"><img src="http://assets.whouz.com/image/ic16_rss.png"></a>
</div>
<div class="sep"></div>
</div>
</div>
<div id="content">

<div class="article">
<div class="inner">
<h2 class="article_title title"><a href="#">在Tornado中获取访客ip
</a></h2>
<div class="article_meta">
<div class="share">
<a href="https://twitter.com/share" class="twitter-share-button" data-via="whouz" data-lang="zh-cn">发推</a>
</div>
<span>on</span>
2012-7-9

</div>
<div class="text">
<p>以前都是用<code>self.request.headers[&#39;X-Real-Ip&#39;]</code>来取访客ip，今天翻源码才发现官方已经给获取好了:</p>
<div class="highlight"><pre><span class="k">if</span> <span class="n">connection</span> <span class="ow">and</span> <span class="n">connection</span><span class="o">.</span><span class="n">xheaders</span><span class="p">:</span>

            <span class="c"># Squid uses X-Forwarded-For, others use X-Real-Ip</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">remote_ip</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>

                <span class="s">&quot;X-Real-Ip&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;X-Forwarded-For&quot;</span><span class="p">,</span> <span class="n">remote_ip</span><span class="p">))</span>
</pre></div>

<p><a href="https://github.com/facebook/tornado/blob/master/tornado/httpserver.py#L358">https://github.com/facebook/tornado/blob/master/tornado/httpserver.py#L358</a></p>

<p>用起来很简单：</p>

<p>把<code>http_server = tornado.httpserver.HTTPServer(application)</code>改成<code>http_server = tornado.httpserver.HTTPServer(application, xheaders=True)</code></p>

<p>然后直接在RequestHandler里使用<code>self.request.remote_ip</code>就可以了</p>

</div>
<div class="big_sep"></div>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0];if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src="//platform.twitter.com/widgets.js";fjs.parentNode.insertBefore(js,fjs);}}(document,"script","twitter-wjs");</script>
<div id="disqus_thread"></div>
<script type="text/javascript">
/* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
var disqus_shortname = 'whtsky'; // required: replace example with your forum shortname
/* * * DON'T EDIT BELOW THIS LINE * * */
(function() {
var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
(document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
</div>
</div>


<a id="next" href="mark-my-catsup-config.html" class="v_nav" >
<span class="icon">Next</span>
</a>


</div>
<div id="footer">
Powered by <a href="https://github.com/whtsky/catsup">CATSUP</a>
<span>&bull;</span>
SealScript Theme by <a href="http://shellex.info">Shellex</a>
<span>&bull;</span>
Hosted on <a href="https://whmcs.hangssh.info/aff.php?aff=144">Host700</a>
</div>
</body>
</html>
